// Generated by CoffeeScript 1.6.3
var defer, sequence, v1;

v1 = require('node-uuid').v1;

defer = require('when').defer;

sequence = require('when/sequence');

exports.create = function(root) {
  var PhraseJob, inject;
  inject = root.inject;
  return PhraseJob = (function() {
    function PhraseJob(opts) {
      var localOpts, property, _fn, _i, _len, _ref,
        _this = this;
      if (opts == null) {
        opts = {};
      }
      opts.uuid || (opts.uuid = v1());
      opts.deferral || (opts.deferral = {
        reject: function(error) {
          throw error;
        },
        notify: function(update) {
          return console.log('PhraseJob:', JSON.stringify(update));
        }
      });
      localOpts = {
        progress: function() {
          return {
            steps: opts.steps != null ? opts.steps.length : 0,
            done: 0
          };
        }
      };
      _ref = ['uuid', 'steps', 'deferral', 'progress'];
      _fn = function(property) {
        return Object.defineProperty(_this, property, {
          enumerable: false,
          get: function() {
            return opts[property] || localOpts[property];
          },
          set: function(value) {
            return opts.deferral.reject(new Error("Cannot assign reserved property: " + property + "(=" + value + ")"));
          }
        });
      };
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        property = _ref[_i];
        _fn(property);
      }
    }

    PhraseJob.prototype.run = function() {
      var running,
        _this = this;
      running = defer();
      this.deferral.notify({
        state: 'run::starting',
        "class": this.constructor.name,
        uuid: this.uuid,
        progress: this.progress(),
        at: Date.now()
      });
      sequence(this.steps.map(function(step) {
        return inject.async({}, step.ref.fn);
      })).then(function() {
        _this.deferral.notify({
          state: 'run::complete',
          "class": _this.constructor.name,
          uuid: _this.uuid,
          progress: _this.progress(),
          at: Date.now()
        });
        return running.resolve({
          job: _this
        });
      });
      return running.promise;
    };

    return PhraseJob;

  })();
};
