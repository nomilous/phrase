// Generated by CoffeeScript 1.6.3
var defer, error;

defer = require('when').defer;

error = function(code, message) {
  return Object.defineProperty(new Error(message), 'code', {
    value: code
  });
};

exports.run = function(root, opts) {
  var context, graph, running, uuid;
  context = root.context;
  graph = context.graph;
  uuid = opts.uuid;
  running = defer();
  process.nextTick(function() {
    var count, leaves, state;
    if (uuid == null) {
      return running.reject(error(1, "missing opts.uuid"));
    }
    if (graph.vertices[uuid] == null) {
      return running.reject(error(2, "uuid: '" + uuid + "' not in local tree"));
    }
    leaves = graph.leavesOf(uuid);
    count = leaves.length;
    state = 'started';
    running.notify({
      timestamp: Date.now(),
      state: state,
      total: count,
      done: count - leaves.length
    });
    return process.nextTick(function() {
      return running.resolve();
    });
  });
  return running.promise;
};
