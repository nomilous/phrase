// Generated by CoffeeScript 1.6.3
var defer, error;

defer = require('when').defer;

error = function(code, message) {
  return Object.defineProperty(new Error(message), 'code', {
    value: code
  });
};

exports.run = function(root, opts) {
  var context, graph, running, uuid;
  context = root.context;
  graph = context.graph;
  uuid = opts.uuid;
  running = defer();
  process.nextTick(function() {
    var count, leaves, recurse, results;
    if (uuid == null) {
      return running.reject(error(1, "missing opts.uuid"));
    }
    if (graph.vertices[uuid] == null) {
      return running.reject(error(2, "uuid: '" + uuid + "' not in local tree"));
    }
    leaves = graph.leavesOf(uuid);
    count = leaves.length;
    results = [];
    recurse = function() {
      var leaf, remaining, state;
      remaining = leaves.length;
      state = remaining === 0 ? 'done' : 'started';
      running.notify({
        timestamp: Date.now(),
        state: state,
        total: count,
        remaining: remaining
      });
      leaf = leaves.shift();
      if (remaining !== 0) {
        return recurse();
      }
      return process.nextTick(function() {
        return running.resolve(results);
      });
    };
    return recurse();
  });
  return running.promise;
};
