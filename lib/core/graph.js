// Generated by CoffeeScript 1.6.3
var Notice, PhraseNode, PhraseTree, TreeWalker;

Notice = require('notice');

PhraseNode = require('../phrase/node');

PhraseTree = require('../phrase/tree');

TreeWalker = require('../recursor/tree_walker');

module.exports.create = function(core) {
  var util;
  util = core.util;
  return core.assembler = function(next, capsule) {
    var OriginPhraseNode, OriginPhraseToken, assemblyOpts, newPhraseControl, newPhraseFn, newPhraseTitle, newPhraseUUID, newRoot, opts, srcControl, srcPhrase, srcRoot;
    if (capsule.phrase !== 'boundry::edge:create') {
      return next();
    }
    srcPhrase = capsule.vertices[0];
    srcControl = capsule.control;
    srcRoot = capsule.root;
    newPhraseTitle = capsule.vertices[1].phrase.title;
    newPhraseControl = capsule.vertices[1].phrase.control;
    newPhraseUUID = capsule.vertices[1].phrase.control.uuid || util.uuid();
    newPhraseFn = capsule.vertices[1].phrase.fn;
    assemblyOpts = capsule.vertices[1].opts;
    newRoot = core.root(newPhraseUUID);
    newRoot.context = {};
    newRoot.context.notice = Notice.create(newPhraseUUID);
    newRoot.context.PhraseTree = PhraseTree.createClass(newRoot);
    newRoot.context.PhraseNode = PhraseNode.createClass(newRoot);
    if (assemblyOpts.loadTree === false) {
      OriginPhraseToken = core.root(capsule.root.uuid).context.PhraseToken;
      OriginPhraseNode = core.root(capsule.root.uuid).context.PhraseNode;
      capsule.assemble = new OriginPhraseNode({
        title: newPhraseTitle,
        uuid: newPhraseUUID,
        token: new OriginPhraseToken({
          signature: srcControl.phraseToken.signature,
          uuid: newPhraseUUID,
          type: 'tree',
          loaded: false,
          source: {
            type: 'file',
            filename: assemblyOpts.filename
          }
        }),
        fn: function(end) {
          return end();
        }
      });
      return next();
    }
    opts = {
      title: srcControl.phraseToken.signature,
      uuid: newPhraseUUID,
      leaf: newPhraseControl.leaf || srcControl.leaf,
      boundry: newPhraseControl.boundry || srcControl.boundry,
      timeout: newPhraseControl.timeout || srcControl.timeout
    };
    newRoot.context.notice.use({
      title: 'this is a complicated way to log something, delete?'
    }, function(next, capsule) {
      return next();
    });
    return TreeWalker.walk(newRoot, opts, newPhraseTitle, newPhraseFn).then(function(resolve) {
      OriginPhraseToken = core.root(capsule.root.uuid).context.PhraseToken;
      OriginPhraseNode = core.root(capsule.root.uuid).context.PhraseNode;
      capsule.assemble = new OriginPhraseNode({
        title: newPhraseTitle,
        uuid: newPhraseUUID,
        token: new OriginPhraseToken({
          signature: srcControl.phraseToken.signature,
          uuid: newPhraseUUID,
          type: 'tree',
          loaded: true,
          source: {
            type: 'file',
            filename: assemblyOpts.filename
          }
        }),
        fn: function(end) {
          return end();
        }
      });
      return next();
    }, function(reject) {
      console.log({
        REJECT: reject
      });
      return next();
    });
  };
};
